#!/bin/sh

_software_prefix="/Users/Shared/Centra"

echo "Uninstalling (you may be prompted for local user password)…"
launchctl unload -w "${HOME}/Library/LaunchAgents/com.wireguard.plist" 2>/dev/null
sudo launchctl unload -w "/Library/LaunchDaemons/com.centra.dnsmasq.plist" 2>/dev/null
sudo launchctl unload -w "/Library/LaunchDaemons/homebrew.mxcl.dnsmasq.plist" 2>/dev/null
rm -f "config/config.toml" "${_software_prefix}/etc/wireguard/wg0.conf"
brew uninstall wireguard-tools dnsmasq 2>/dev/null
rm -rf /opt/homebrew/etc/dnsmasq.*

# clean the "new" prefix
if [ -d "${_software_prefix}" ]; then
    rm -rf "${_software_prefix}"
fi

echo "Falling back to the default DNS…"
for _network in $(networksetup -listallnetworkservices | grep -E "Wi-Fi|Ethernet"); do
    networksetup -setdnsservers "${_network}" "1.1.1.1"
done
